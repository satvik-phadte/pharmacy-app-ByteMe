{% extends 'authentication/base.html' %}
{% load webpush_notifications %}
{% load static %}

{% block title %}Homepage - Pharmacy App{% endblock %}

{% block container_class %}homepage-container{% endblock %}

{% block content %}
<div class="welcome-card">
    <h1>Welcome to Your Pharmacy App</h1>
    <p>Your trusted platform for pharmacy management.</p>

    <div class="user-info">
        <h3>Account</h3>
        <p><strong>Username:</strong> {{ user.username }}</p>
        <p><strong>Account Type:</strong>
            {% if user.is_pharmacy %}
                <span class="pharmacy-badge">Pharmacy</span>
            {% else %}
                <span style="color: #e6eef8;">Regular User</span>
            {% endif %}
        </p>
    </div>

    <!-- Floating Reminder Icon (for regular users) -->
    {% if not user.is_pharmacy and reminders %}
    <button id="reminderFloatingBtn" style="position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 1000; transition: all 0.3s ease;">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0 1 18.6 14.6V11a6 6 0 1 0-12 0v3.6c0 .53-.21 1.04-.59 1.405L4 17h5" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="#ffffff" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span id="reminderBadge" style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; display: none; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700;"></span>
    </button>

    <!-- Reminder Overlay -->
    <div id="reminderOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 1100; align-items: center; justify-content: center;">
        <div style="background: #0a1628; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: rgba(255, 255, 255, 0.95); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0 1 18.6 14.6V11a6 6 0 1 0-12 0v3.6c0 .53-.21 1.04-.59 1.405L4 17h5" stroke="#a5b4fc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="#a5b4fc" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Today's Reminders
                </h3>
                <button id="closeOverlay" style="background: none; border: none; color: rgba(255, 255, 255, 0.7); font-size: 1.5rem; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s;">
                    ✕
                </button>
            </div>
            
            <div style="display: grid; gap: 1rem;">
                {% for reminder in reminders %}
                <div class="reminder-item" data-reminder-id="{{ reminder.id }}" style="background: #071533; border: 1px solid rgba(165, 180, 252, 0.2); border-radius: 8px; padding: 1rem; transition: all 0.2s;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong style="color: rgba(255, 255, 255, 0.95); font-size: 1.05rem;">{{ reminder.medicine_name }}</strong>
                            <p style="color: rgba(255, 255, 255, 0.7); margin-top: 0.25rem; font-size: 0.85rem;">
                                {{ reminder.get_frequency_display }} at {{ reminder.time }}
                            </p>
                        </div>
                        {% if reminder.id in reminders_taken_today_ids %}
                        <span style="color: #10b981; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M5 13l4 4L19 7" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Taken
                        </span>
                        {% else %}
                        <button class="mark-taken-btn" data-reminder-id="{{ reminder.id }}" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            Mark as Taken
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <a href="{% url 'authentication:reminders' %}" style="display: inline-block; margin-top: 1.5rem; color: #a5b4fc; text-decoration: none; font-weight: 600; font-size: 0.95rem;">
                Manage All Reminders →
            </a>
        </div>
    </div>

    <script>
        // Calculate and display badge count on page load
        function updateBadgeCount() {
            const pendingButtons = document.querySelectorAll('.mark-taken-btn');
            const count = pendingButtons.length;
            const badge = document.getElementById('reminderBadge');
            
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Update badge count on page load
        updateBadgeCount();
        
        // Toggle overlay
        document.getElementById('reminderFloatingBtn').addEventListener('click', function() {
            document.getElementById('reminderOverlay').style.display = 'flex';
        });

        document.getElementById('closeOverlay').addEventListener('click', function() {
            document.getElementById('reminderOverlay').style.display = 'none';
        });

        document.getElementById('reminderOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // Mark as taken functionality
        document.querySelectorAll('.mark-taken-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Button clicked!');
                
                const reminderId = this.getAttribute('data-reminder-id');
                const button = this;
                
                console.log('Reminder ID:', reminderId);
                
                // Get CSRF token from cookie
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                
                const csrftoken = getCookie('csrftoken');
                
                // Disable button during request
                button.disabled = true;
                button.style.opacity = '0.6';
                button.textContent = 'Marking...';
                
                // Send AJAX request to mark as taken
                fetch('/auth/customer/reminders/' + reminderId + '/mark-taken/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.success) {
                        // Create the "Taken" status element
                        const takenSpan = document.createElement('span');
                        takenSpan.style.cssText = 'color: #10b981; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;';
                        takenSpan.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 13l4 4L19 7" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>Taken';
                        
                        // Replace the button with the "Taken" status
                        button.replaceWith(takenSpan);
                        
                        // Update badge count
                        updateBadgeCount();
                    } else {
                        alert('Failed to mark reminder as taken');
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.textContent = 'Mark as Taken';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error: ' + error.message);
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.textContent = 'Mark as Taken';
                });
            });
        });
    </script>
    {% endif %}

    <!-- Features overview (homepage no longer contains forms) -->
    <section class="dashboard-section">
        <h3>What you can do</h3>
        <div class="action-grid" style="margin-top:1rem;">
            <div class="action-card">
                <div class="action-icon" aria-hidden="true">
                    <!-- Magnifier SVG -->
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M21 21l-4.35-4.35" stroke="#cfe0ff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="11" cy="11" r="6" stroke="#cfe0ff" stroke-width="1.6" fill="none"/>
                    </svg>
                </div>
                <div class="action-text">Search medicines across nearby pharmacies and compare prices.</div>
            </div>
            <div class="action-card">
                <div class="action-icon" aria-hidden="true">
                    <!-- Box / inventory SVG -->
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 7l9-4 9 4v8l-9 4-9-4V7z" stroke="#cfe0ff" stroke-width="1.4" fill="none" stroke-linejoin="round"/>
                        <path d="M12 3v8" stroke="#cfe0ff" stroke-width="1.4" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="action-text">Manage inventory (pharmacies): add, edit, bulk-upload medicines.</div>
            </div>
            <div class="action-card">
                <div class="action-icon" aria-hidden="true">
                    <!-- Map pin SVG -->
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 21s8-5.5 8-11a8 8 0 1 0-16 0c0 5.5 8 11 8 11z" stroke="#cfe0ff" stroke-width="1.4" fill="none"/>
                        <circle cx="12" cy="10" r="2.2" fill="#cfe0ff"/>
                    </svg>
                </div>
                <div class="action-text">Set and update pharmacy or customer locations via the Locations page.</div>
            </div>
            <div class="action-card">
                <div class="action-icon" aria-hidden="true">
                    <!-- Clock / reminder SVG -->
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="8" stroke="#cfe0ff" stroke-width="1.4" fill="none"/>
                        <path d="M12 8v5l3 2" stroke="#cfe0ff" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="action-text">Create reminders to manage medication schedules (Reminders page).</div>
            </div>
            <div class="action-card">
                <div class="action-icon" aria-hidden="true">
                    <!-- Bell / notification SVG -->
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0 1 18.6 14.6V11a6 6 0 1 0-12 0v3.6c0 .53-.21 1.04-.59 1.405L4 17h5" stroke="#cfe0ff" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="#cfe0ff" stroke-width="1.4" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="action-text">Enable browser notifications to receive alerts about low stock and reminders.</div>
            </div>
        </div>
        
    </section>

</div>

{% endblock %}
