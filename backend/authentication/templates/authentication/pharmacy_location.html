{% extends 'authentication/base.html' %}

{% block title %}Pharmacy Location - Pharmacy App{% endblock %}

{% block container_class %}location-container{% endblock %}

{% block content %}
<div class="header">
    <h1>üìç Pharmacy Location</h1>
    <p>Set your pharmacy location on the map</p>
</div>

<form method="post" id="locationForm">
    {% csrf_token %}
    
    <div class="form-group">
        <label for="{{ form.name.id_for_label }}">Pharmacy Name</label>
        {{ form.name }}
        {% if form.name.errors %}
        <div class="message error">
            {{ form.name.errors.0 }}
        </div>
        {% endif %}
    </div>
    
    <div class="form-group">
        <label for="{{ form.phone.id_for_label }}">Phone Number</label>
        {{ form.phone }}
        {% if form.phone.errors %}
        <div class="message error">
            {{ form.phone.errors.0 }}
        </div>
        {% endif %}
    </div>
    
    <!-- Map Section -->
    <div class="form-group">
        <label>Set Your Pharmacy Location</label>
        <input type="text" id="locationSearch" placeholder="Search for an address..." />
        <div id="map"></div>
        <div class="location-controls">
            <button type="button" id="getCurrentLocation" class="btn-map">
                üìç Use My Current Location
            </button>
            <button type="button" id="clearLocation" class="btn-map" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                 Clear Location
            </button>
        </div>
        <p class="map-help-text">
            Click on the map to set your pharmacy location, or use the search box above
        </p>
    </div>

    <!-- Address Field (Auto-filled) -->
    <div class="form-group">
        <label for="{{ form.address.id_for_label }}">Address (Auto-filled)</label>
        {{ form.address }}
        {% if form.address.errors %}
        <div class="message error">
            {{ form.address.errors.0 }}
        </div>
        {% endif %}
    </div>

    <!-- Coordinates Display -->
    <div class="coordinates-display" id="coordinatesDisplay" style="display: none;">
        <strong>Selected Coordinates:</strong><br>
        <span id="coordText">No location selected</span>
    </div>
    
    <!-- Hidden coordinate fields -->
    {{ form.latitude }}
    {{ form.longitude }}
    
    <button type="submit" class="btn" id="saveButton" disabled>Save Location</button>
</form>

<div class="links">
    <a href="{% url 'authentication:homepage' %}">‚Üê Back to Homepage</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map - Default to India center
    const map = L.map('map').setView([20.5937, 78.9629], 5);

    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    let marker = null;
    const latField = document.getElementById('{{ form.latitude.id_for_label }}');
    const lngField = document.getElementById('{{ form.longitude.id_for_label }}');
    const addressField = document.getElementById('{{ form.address.id_for_label }}');
    const coordinatesDisplay = document.getElementById('coordinatesDisplay');
    const coordText = document.getElementById('coordText');
    const saveButton = document.getElementById('saveButton');

    // Check if there's existing location data
    if (latField.value && lngField.value) {
        const lat = parseFloat(latField.value);
        const lng = parseFloat(lngField.value);
        setLocation(lat, lng, false); // Don't reverse geocode existing address
    }

    // Function to set location
    function setLocation(lat, lng, reverseGeocode = true) {
        if (marker) {
            map.removeLayer(marker);
        }
        
        marker = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 15);
        
        // Update form fields
        latField.value = lat.toFixed(6);
        lngField.value = lng.toFixed(6);
        
        // Update display
        coordinatesDisplay.style.display = 'block';
        coordText.textContent = `Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(6)}`;
        saveButton.disabled = false;
        
        // Reverse geocoding to get address
        if (reverseGeocode) {
            reverseGeocodeLocation(lat, lng);
        }
    }

    // Click handler for map
    map.on('click', function(e) {
        setLocation(e.latlng.lat, e.latlng.lng);
    });

    // Get current location
    document.getElementById('getCurrentLocation').addEventListener('click', function() {
        if (navigator.geolocation) {
            this.textContent = 'üìç Getting location...';
            this.disabled = true;
            
            navigator.geolocation.getCurrentPosition(function(position) {
                setLocation(position.coords.latitude, position.coords.longitude);
                document.getElementById('getCurrentLocation').textContent = 'üìç Use My Current Location';
                document.getElementById('getCurrentLocation').disabled = false;
            }, function(error) {
                alert('Unable to get your location: ' + error.message + '. Please click on the map instead.');
                document.getElementById('getCurrentLocation').textContent = 'üìç Use My Current Location';
                document.getElementById('getCurrentLocation').disabled = false;
            });
        } else {
            alert('Geolocation is not supported by this browser. Please click on the map instead.');
        }
    });

    // Clear location
    document.getElementById('clearLocation').addEventListener('click', function() {
        if (marker) {
            map.removeLayer(marker);
            marker = null;
        }
        latField.value = '';
        lngField.value = '';
        addressField.value = '';
        coordinatesDisplay.style.display = 'none';
        saveButton.disabled = true;
        map.setView([20.5937, 78.9629], 5);
    });

    // Search functionality
    const searchBox = document.getElementById('locationSearch');
    let searchTimeout;
    
    searchBox.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchLocation(this.value);
        }
    });

    searchBox.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (this.value.length > 3) {
                searchLocation(this.value);
            }
        }, 1000);
    });

    // Search for location
    async function searchLocation(query) {
        if (!query.trim()) return;
        
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
            const results = await response.json();
            
            if (results.length > 0) {
                const result = results[0];
                setLocation(parseFloat(result.lat), parseFloat(result.lon), false);
                addressField.value = result.display_name;
            } else {
                alert('Location not found. Please try a different search term or click on the map.');
            }
        } catch (error) {
            console.error('Search error:', error);
            alert('Search failed. Please click on the map to set your location.');
        }
    }

    // Reverse geocoding function
    async function reverseGeocodeLocation(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await response.json();
            if (data.display_name) {
                addressField.value = data.display_name;
            }
        } catch (error) {
            console.log('Address lookup failed:', error);
        }
    }

    // Form validation
    document.getElementById('locationForm').addEventListener('submit', function(e) {
        if (!latField.value || !lngField.value) {
            e.preventDefault();
            alert('Please select a location on the map before saving.');
        }
    });
});
</script>
{% endblock %}
