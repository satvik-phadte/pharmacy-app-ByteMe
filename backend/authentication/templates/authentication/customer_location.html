{% extends 'authentication/base.html' %}

{% block title %}Set Location - Pharmacy App{% endblock %}

{% block container_class %}location-container{% endblock %}

{% block content %}
<div class="header">
    <h1> Set Your Location</h1>
    <p>Set your location to find nearby pharmacies</p>
</div>

<form method="post" id="locationForm">
    {% csrf_token %}
    
    <!-- Side-by-side layout: map on left, controls on right -->
    <div style="display: grid; grid-template-columns: 1fr 380px; gap: 2rem; align-items: start; width: 100%; max-width: 100%;">
        
        <!-- Left: Map Section -->
        <div style="min-width: 0; width: 100%;">
            <div class="form-group">
                <input type="text" id="locationSearch" placeholder="Search for an address..." style="margin-bottom: 1rem; width: 100%;" />
                <div id="map" style="height: 600px; width: 100%;"></div>
                <p class="map-help-text">
                    Click on the map to set your location, or use the search box above
                </p>
            </div>
        </div>

        <!-- Right: Controls Section -->
        <div style="display: flex; flex-direction: column; gap: 2rem; padding: 1rem; min-width: 380px;">
            
            <!-- Location action buttons -->
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <button type="button" id="getCurrentLocation" class="btn" style="width: 100%; padding: 1rem; font-size: 1rem;">
                    üìç Use My Current Location
                </button>
                <button type="button" id="clearLocation" class="btn" style="width: 100%; padding: 1rem; font-size: 1rem;">
                    üóëÔ∏è Clear Location
                </button>
            </div>

            <!-- Address Field (Auto-filled) -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="{{ form.address.id_for_label }}" style="font-size: 1rem; margin-bottom: 0.75rem; display: block;">Address (Auto-filled)</label>
                {{ form.address }}
                {% if form.address.errors %}
                <div class="message error">
                    {{ form.address.errors.0 }}
                </div>
                {% endif %}
            </div>

            <!-- Coordinates Display -->
            <div class="coordinates-display" id="coordinatesDisplay" style="display: none; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; font-size: 0.95rem;">
                <strong style="display: block; margin-bottom: 0.5rem;">Selected Coordinates:</strong>
                <span id="coordText">No location selected</span>
            </div>
            
            <!-- Hidden coordinate fields -->
            {{ form.latitude }}
            {{ form.longitude }}
            
            <button type="submit" class="btn" id="saveButton" disabled style="margin-top: auto; padding: 1rem; font-size: 1rem;">Save Location</button>
        </div>

    </div>
</form>

<div class="links">
    <a href="{% url 'authentication:homepage' %}">‚Üê Back to Homepage</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map - Default to India center
    const map = L.map('map').setView([20.5937, 78.9629], 5);

    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    let marker = null;
    const latField = document.getElementById('{{ form.latitude.id_for_label }}');
    const lngField = document.getElementById('{{ form.longitude.id_for_label }}');
    const addressField = document.getElementById('{{ form.address.id_for_label }}');
    const coordinatesDisplay = document.getElementById('coordinatesDisplay');
    const coordText = document.getElementById('coordText');
    const saveButton = document.getElementById('saveButton');

    // Check if there's existing location data
    if (latField.value && lngField.value) {
        const lat = parseFloat(latField.value);
        const lng = parseFloat(lngField.value);
        setLocation(lat, lng, false); // Don't reverse geocode existing address
    }

    // Function to set location
    function setLocation(lat, lng, reverseGeocode = true) {
        if (marker) {
            map.removeLayer(marker);
        }
        
        marker = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 15);
        
        // Update form fields
        latField.value = lat.toFixed(6);
        lngField.value = lng.toFixed(6);
        
        // Update display
        coordinatesDisplay.style.display = 'block';
        coordText.textContent = `Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(6)}`;
        saveButton.disabled = false;
        
        // Reverse geocoding to get address
        if (reverseGeocode) {
            reverseGeocodeLocation(lat, lng);
        }
    }

    // Click handler for map
    map.on('click', function(e) {
        setLocation(e.latlng.lat, e.latlng.lng);
    });

    // Get current location
    document.getElementById('getCurrentLocation').addEventListener('click', function() {
        if (navigator.geolocation) {
            this.textContent = 'üìç Getting location...';
            this.disabled = true;
            
            navigator.geolocation.getCurrentPosition(function(position) {
                setLocation(position.coords.latitude, position.coords.longitude);
                document.getElementById('getCurrentLocation').textContent = 'üìç Use My Current Location';
                document.getElementById('getCurrentLocation').disabled = false;
            }, function(error) {
                alert('Unable to get your location: ' + error.message + '. Please click on the map instead.');
                document.getElementById('getCurrentLocation').textContent = 'üìç Use My Current Location';
                document.getElementById('getCurrentLocation').disabled = false;
            });
        } else {
            alert('Geolocation is not supported by this browser. Please click on the map instead.');
        }
    });

    // Clear location
    document.getElementById('clearLocation').addEventListener('click', function() {
        if (marker) {
            map.removeLayer(marker);
            marker = null;
        }
        latField.value = '';
        lngField.value = '';
        addressField.value = '';
        coordinatesDisplay.style.display = 'none';
        saveButton.disabled = true;
        map.setView([20.5937, 78.9629], 5);
    });

    // Search functionality
    const searchBox = document.getElementById('locationSearch');
    let searchTimeout;
    
    searchBox.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchLocation(this.value);
        }
    });

    searchBox.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (this.value.length > 3) {
                searchLocation(this.value);
            }
        }, 1000);
    });

    // Search for location
    async function searchLocation(query) {
        if (!query.trim()) return;
        
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
            const results = await response.json();
            
            if (results.length > 0) {
                const result = results[0];
                setLocation(parseFloat(result.lat), parseFloat(result.lon), false);
                addressField.value = result.display_name;
            } else {
                alert('Location not found. Please try a different search term or click on the map.');
            }
        } catch (error) {
            console.error('Search error:', error);
            alert('Search failed. Please click on the map to set your location.');
        }
    }

    // Reverse geocoding function
    async function reverseGeocodeLocation(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await response.json();
            if (data.display_name) {
                addressField.value = data.display_name;
            }
        } catch (error) {
            console.log('Address lookup failed:', error);
        }
    }

    // Form validation
    document.getElementById('locationForm').addEventListener('submit', function(e) {
        if (!latField.value || !lngField.value) {
            e.preventDefault();
            alert('Please select a location on the map before saving.');
        }
    });
});
</script>
{% endblock %}
