{% extends 'authentication/base.html' %}

{% block title %}My Prescriptions - Pharmacy App{% endblock %}

{% block container_class %}prescriptions-container{% endblock %}

{% block content %}
<div class="header">
    <h1>üìÑ My Prescriptions</h1>
    <p>Upload and manage your prescription images</p>
</div>

<!-- Upload Form -->
<div style="background: #07112a; border: 1px solid rgba(255, 255, 255, 0.03); padding: 2rem; border-radius: 12px; margin-bottom: 2rem; max-width: 600px;">
    <h3 style="color: rgba(255, 255, 255, 0.95); margin-bottom: 1.5rem;">Upload New Prescription</h3>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="{{ form.image.id_for_label }}">Prescription Image</label>
            {{ form.image }}
            {% if form.image.errors %}
            <div class="message error">
                {{ form.image.errors.0 }}
            </div>
            {% endif %}
            <p style="color: rgba(255, 255, 255, 0.5); font-size: 0.85rem; margin-top: 0.5rem;">
                Supported formats: JPG, PNG, HEIC. Max size: 5MB
            </p>
        </div>
        
        <div class="form-group">
            <label for="{{ form.notes.id_for_label }}">Notes (Optional)</label>
            {{ form.notes }}
            {% if form.notes.errors %}
            <div class="message error">
                {{ form.notes.errors.0 }}
            </div>
            {% endif %}
        </div>
        
        <button type="submit" class="btn" style="width: 100%;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 0.5rem;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="17 8 12 3 7 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Upload Prescription
        </button>
    </form>
</div>

<!-- Prescriptions Grid -->
{% if prescriptions %}
<div style="margin-bottom: 2rem;">
    <h3 style="color: rgba(255, 255, 255, 0.95); margin-bottom: 1.5rem;">Your Prescriptions ({{ prescriptions|length }})</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
        {% for prescription in prescriptions %}
        <div style="background: #071533; border: 1px solid rgba(255, 255, 255, 0.04); border-radius: 12px; overflow: hidden; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 40px rgba(102, 126, 234, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            <!-- Image -->
            <div style="position: relative; padding-top: 75%; background: #0a1628; overflow: hidden;">
                <img src="{{ prescription.image.url }}" alt="Prescription" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
                <a href="{{ prescription.image.url }}" target="_blank" style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(0, 0, 0, 0.7); color: white; padding: 0.5rem; border-radius: 6px; text-decoration: none; font-size: 0.85rem; display: flex; align-items: center; gap: 0.3rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    View Full
                </a>
            </div>
            
            <!-- Details -->
            <div style="padding: 1.2rem;">
                <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.85rem; margin-bottom: 0.5rem;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline; margin-right: 0.3rem;">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <polyline points="12 6 12 12 16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    {{ prescription.uploaded_at|date:"F d, Y" }} at {{ prescription.uploaded_at|time:"g:i A" }}
                </p>
                
                {% if prescription.notes %}
                <p style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; margin-bottom: 1rem; line-height: 1.5;">
                    {{ prescription.notes }}
                </p>
                {% endif %}
                
                <!-- Extracted Text -->
                {% if prescription.extracted_text %}
                <div style="background: rgba(102, 126, 234, 0.1); border-left: 3px solid #667eea; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">
                    <p style="color: rgba(255, 255, 255, 0.9); font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem;">üìã Extracted Text:</p>
                    <p id="extracted-text-{{ prescription.pk }}" style="color: rgba(255, 255, 255, 0.75); font-size: 0.85rem; line-height: 1.5; white-space: pre-wrap; max-height: 150px; overflow-y: auto;">{{ prescription.extracted_text }}</p>
                </div>
                {% else %}
                <div id="extracted-text-container-{{ prescription.pk }}" style="display: none; background: rgba(102, 126, 234, 0.1); border-left: 3px solid #667eea; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">
                    <p style="color: rgba(255, 255, 255, 0.9); font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem;">üìã Extracted Text:</p>
                    <p id="extracted-text-{{ prescription.pk }}" style="color: rgba(255, 255, 255, 0.75); font-size: 0.85rem; line-height: 1.5; white-space: pre-wrap; max-height: 150px; overflow-y: auto;"></p>
                </div>
                {% endif %}
                
                <!-- Extract Text Button -->
                {% if not prescription.extracted_text %}
                <button onclick="extractText({{ prescription.pk }})" id="extract-btn-{{ prescription.pk }}" class="btn" style="width: 100%; margin-bottom: 0.5rem; font-size: 0.85rem; padding: 0.6rem 1rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline; margin-right: 0.3rem;">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Extract Text with AI
                </button>
                {% endif %}
                
                <!-- Delete Button -->
                <form method="post" action="{% url 'authentication:prescription_delete' prescription.pk %}" onsubmit="return confirm('Are you sure you want to delete this prescription?');" style="margin-top: 1rem;">
                    {% csrf_token %}
                    <button type="submit" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; width: 100%; transition: all 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline; margin-right: 0.3rem;">
                            <polyline points="3 6 5 6 21 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Delete
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div style="text-align: center; padding: 3rem; background: #071533; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.04);">
    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 1rem; opacity: 0.3;">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="#a5b4fc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="14 2 14 8 20 8" stroke="#a5b4fc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <h3 style="color: rgba(255, 255, 255, 0.7); margin-bottom: 0.5rem;">No prescriptions yet</h3>
    <p style="color: rgba(255, 255, 255, 0.5);">Upload your first prescription using the form above</p>
</div>
{% endif %}

<div class="links">
    <a href="{% url 'authentication:homepage' %}">‚Üê Back to Homepage</a>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function extractText(prescriptionId) {
    const button = document.getElementById(`extract-btn-${prescriptionId}`);
    const originalContent = button.innerHTML;
    
    // Disable button and show loading
    button.disabled = true;
    button.style.opacity = '0.6';
    button.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline; margin-right: 0.3rem; animation: spin 1s linear infinite;">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="8"/>
        </svg>
        Extracting...
    `;
    
    try {
        const response = await fetch(`/auth/customer/prescriptions/${prescriptionId}/extract-text/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show extracted text
            const container = document.getElementById(`extracted-text-container-${prescriptionId}`);
            const textElement = document.getElementById(`extracted-text-${prescriptionId}`);
            textElement.textContent = data.extracted_text;
            container.style.display = 'block';
            
            // Hide the extract button
            button.style.display = 'none';
            
            // Show success message
            alert('‚úÖ Text extracted successfully!');
        } else {
            alert('‚ùå Error: ' + data.error);
            button.disabled = false;
            button.style.opacity = '1';
            button.innerHTML = originalContent;
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Failed to extract text. Please try again.');
        button.disabled = false;
        button.style.opacity = '1';
        button.innerHTML = originalContent;
    }
}
</script>

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}
